#!/bin/bash

# Parallel launcher for the various PEs on Legion.
# Dr Owain Kenway, UCL

# For licensing terms, see LICENSE.txt

# This variable should be set by MPI modules:
# GERUN_LAUNCHER

echo 

# Check to see if we have a customised message and if so use it rather 
# than the default.
if [ -e $GERUN_PATH/local-message ]
then
  cat $GERUN_PATH/local-message 
else
  cat $GERUN_PATH/gerun-message
fi

# We need to support mixed mode code on new Legion.

OMP_NUM_THREADS=${OMP_NUM_THREADS:-1}
NSLOTS=${NSLOTS:-1}
GERUN_PROCS=$[$NSLOTS/$OMP_NUM_THREADS]
export OMP_NUM_THREADS
export GERUN_PROCS

echo
echo "Using environment: $GERUN_LAUNCHER"
echo "Running on $GERUN_PROCS slots."
echo "TMPDIR=$TMPDIR"
echo

if [ -f $TMPDIR/machines ]
then
  echo "Contents of machinefile:"
  cat $TMPDIR/machines
else
  echo "WARNING: No machine file."
fi 
echo

$GERUN_PATH/gerun-$GERUN_LAUNCHER $*
